class LeanCloudCounter{constructor(e,t,o){this.appId=e,this.appKey=t,this.apiServer=o}leancloudSelector(e){return e=encodeURI(e),document.getElementById(e).querySelector(".leancloud-visitors-count")}async request(e,t,o){return fetch(this.apiServer+"/1.1"+t,{method:e,headers:{"X-LC-Id":this.appId,"X-LC-Key":this.appKey,"Content-Type":"application/json"},body:JSON.stringify(o)})}async addCount(){var e=document.querySelector(".leancloud_visitors"),t=decodeURI(e.id),e=e.dataset.flagTitle;try{const s=await this.request("get","/classes/Counter?where="+encodeURIComponent(JSON.stringify({url:t})));var o=(await s.json())["results"];if(0<o.length){var r=o[0];this.leancloudSelector(t).innerText=r.time+1;try{await this.request("put","/classes/Counter/"+r.objectId,{time:{__op:"Increment",amount:1}})}catch(e){console.error("Failed to save visitor count",e)}}else if(CONFIG.leancloud_visitors.security)this.leancloudSelector(t).innerText="Counter not initialized! More info at console err msg.",console.error("ATTENTION! LeanCloud counter has security bug, see how to solve it here: https://github.com/theme-next/hexo-leancloud-counter-security. \n However, you can still use LeanCloud without security, by setting `security` option to `false`.");else try{const n=await this.request("post","/classes/Counter",{title:e,url:t,time:1});await n.json(),this.leancloudSelector(t).innerText=1}catch(e){console.error("Failed to create",e)}}catch(e){console.error("LeanCloud Counter Error",e)}}async showTime(){var e=[...document.querySelectorAll(".leancloud_visitors")].map(e=>decodeURI(e.id));try{const o=await this.request("get","/classes/Counter?where="+encodeURIComponent(JSON.stringify({url:{$in:e}}))),r=(await o.json())["results"];for(const s of e){var t=r.find(e=>e.url===s);this.leancloudSelector(s).innerText=t?t.time:0}}catch(e){console.error("LeanCloud Counter Error",e)}}}!function(){const{app_id:o,app_key:r,server_url:e}=CONFIG.leancloud_visitors,t=e=>{const t=new LeanCloudCounter(o,r,e);CONFIG.page.isPost?CONFIG.hostname===location.hostname&&t.addCount():1<=document.querySelectorAll(".post-title-link").length&&t.showTime()};let s;e?s=e:"-MdYXbMMI"===o.slice(-9)&&(s=`https://${o.slice(0,8).toLowerCase()}.api.lncldglobal.com`),document.addEventListener("page:loaded",async()=>{if(s)t(s);else try{const e=await fetch("https://app-router.leancloud.cn/2/route?appId="+o),s=(await e.json())["api_server"];t("https://"+s)}catch(e){console.error("Failed to fetch API server",e)}})}();